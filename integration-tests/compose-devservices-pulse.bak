services:
  postgres:
    image: postgres:17.6-alpine3.22
    labels:
      io.quarkus.devservices.compose.wait_for.logs: .*database system is ready to accept connections.*
    restart: always
    healthcheck:
      test: 'pg_isready'
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "5432"
    environment:
      POSTGRES_USER: quarkus
      POSTGRES_DB: quarkus
      POSTGRES_PASSWORD: password
    command: |
      postgres
      -c wal_level=logical
      -c hot_standby=on
      -c max_wal_senders=10
      -c max_replication_slots=10
      -c synchronized_standby_slots=replication_slot

  kafka:
    image: debezium-for-dev-service/kafka:3.3.1.Final
    # image: quay.io/debezium/kafka:3.3.1.Final
    labels:
      io.quarkus.devservices.compose.exposed_ports: /tmp/ports
    ports:
      - "9092"
      - "29092"
    environment:
      - CLUSTER_ID=oh-sxaDRTcyAr6pFRbXyzA
      - NODE_ID=1
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
    healthcheck:
      test: ["CMD", "./bin/kafka-topics.sh", "--bootstrap-server", "kafka:29092", "--list"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  connect:
    image: quay.io/debezium/connect:3.3.1.Final
    labels:
      io.quarkus.devservices.compose.config_map.port.8083: pulse.debezium.connect.port
    ports:
      - "8083"
    links:
      - kafka
      - postgres
    environment:
      - BOOTSTRAP_SERVERS=kafka:29092
      - GROUP_ID=1
      - CONFIG_STORAGE_TOPIC=my_connect_configs
      - OFFSET_STORAGE_TOPIC=my_connect_offsets
      - STATUS_STORAGE_TOPIC=my_connect_statuses
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/connectors"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
